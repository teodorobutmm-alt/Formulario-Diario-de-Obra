<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Di√°rio de Obra</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --cor-principal:#c40000;
      --cor-principal-escura:#8f0000;
      --cinza-linha:#d9d9d9;
      --cinza-box:#f3f3f3;
      --texto:#2f2f2f;
      --linha-secao:#e3e3e3;
      --cinza-card:#f1f1f1;
      --vermelho-linha: rgba(196, 0, 0, 0.25);
    }

    html, body {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
      background-color: #ffffff;
      color: var(--texto);
      font-size: 12px;
    }

    *, *:before, *:after {
      box-sizing: inherit;
      font-family: Arial, sans-serif;
    }

    .container {
      max-width: 920px;
      margin: 0 auto;
      padding: 18px;
    }

    /* CABE√áALHO */
    .header-container{
      display:flex;
      align-items:center;
      justify-content: center;
      gap: 55px;
      margin-bottom: 10px;
      flex-wrap: nowrap;
    }
    .header-container img{
      height: 44px;
      width:auto;
      object-fit: contain;
      display:block;
    }

    /* TOPO */
    .topo-bloco{
      width: 100%;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 0 1px #e3e3e3;
      padding: 14px;
      margin: 0 0 14px 0;
    }

    .topo-titulo-box{
      border: 1px solid #e3e3e3;
      border-radius: 10px;
      padding: 10px 12px;
      text-align: center;
      margin-bottom: 12px;
      background: var(--cor-principal);
    }

    .topo-titulo-box .titulo-principal{
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .3px;
      margin: 0;
      color: #fff;
    }

    .topo-titulo-box .titulo-sub{
      margin-top: 4px;
      font-size: 12px;
      font-weight: 900;
      color: #fff;
      letter-spacing: .2px;
    }

    .topo-titulo-box .titulo-sub .destaque{
      color: #fff;
      text-decoration: none;
    }

    .topo-campos-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: stretch;
    }

    .campo-topo{
      background: var(--cinza-card);
      border-radius: 10px;
      padding: 10px;
    }

    .campo-topo label{
      display:block;
      font-size: 12px;
      font-weight: 900;
      color: var(--cor-principal);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .3px;
    }

    .campo-topo label.required::after{
      content: ' *';
      color: red;
      font-weight: bold;
      margin-left: 4px;
    }

    .campo-topo input{
      width:100%;
      height: 38px;
      border: 1px solid #d5d5d5;
      border-radius: 8px;
      padding: 9px;
      font-size: 12px;
      background:#fff;
      box-sizing: border-box;
    }

    label{
      font-size: 12px;
      font-weight: 900;
      margin-bottom: 6px;
      display: inline-block;
    }

    label.required::after {
      content: ' *';
      color: red;
      font-weight: bold;
      margin-left: 4px;
    }

    input[type="text"],
    input[type="date"],
    input[type="url"],
    input[type="number"]{
      border: 1px solid var(--cinza-linha);
      border-radius: 3px;
      padding: 8px;
      font-size: 12px;
      width: 100%;
      font-family: Arial, sans-serif;
      background:#fff;
      height: 38px;
      box-sizing: border-box;
    }

    textarea{
      border: 1px solid var(--cinza-linha);
      border-radius: 3px;
      padding: 8px;
      font-size: 12px;
      width: 100%;
      font-family: Arial, sans-serif;
      background:#fff;
      box-sizing: border-box;
    }

    #descricao,
    #comentarios,
    #rev_descricao,
    #rev_comentarios {
      height: 100px;
      resize: none;
    }

    .char-count {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
      text-align: right;
      display: block;
    }

    #obra, #inicio, #termino{
      background: var(--cinza-box);
    }

    .separador{
      border-top: 1px solid var(--vermelho-linha);
      margin: 14px 0;
    }

    /* BLOCO CLIMA / OBRA */
    .quadrado-blocos{
      border: none;
      border-radius: 0;
      padding: 0;
      background: transparent;
    }

    .linha-dupla-checks{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: stretch;
    }

    .bloco-checks{
      border: 1px solid var(--cinza-linha);
      border-radius: 6px;
      padding: 12px;
      background: #fff;
      min-height: 140px;
    }

    .bloco-checks .titulo-bloco{
      display:block;
      font-size: 12px;
      font-weight: 900;
      margin-bottom: 10px;
    }

    #grupoClima,
    #rev_grupoClima{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 12px;
    }

    #grupoClima label,
    #rev_grupoClima label{
      display:flex;
      align-items:center;
      gap: 6px;
      font-weight: 800;
      font-size: 12px;
      margin: 0;
      white-space: nowrap;
    }

    #grupoClima label img,
    #rev_grupoClima label img{
      height: 20px;
      width:auto;
    }

    #grupoObra,
    #rev_grupoObra{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    #grupoObra label,
    #rev_grupoObra label{
      display:flex;
      align-items:center;
      gap: 6px;
      font-weight: 800;
      font-size: 12px;
      margin: 0;
    }

    /* =========================
       Presentes / Ausentes / Terceirizados
       ========================= */
    .bloco-efetivo-card{
      border: 1px solid #e3e3e3;
      border-radius: 12px;
      background: #fff;
      padding: 12px;
      overflow: visible;
    }

    .bloco-efetivo-titulo{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .3px;
      font-size: 14px;
      margin: 0 0 10px 0;
    }

    .bloco-efetivo-titulo .emoji{ font-size: 18px; }

    .tabela-efetivo{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      overflow: hidden;
      background:#fff;
      table-layout: auto;
    }

    .tabela-efetivo thead th{
      background:#f3f3f3;
      color:#333;
      font-size: 12px;
      font-weight: 900;
      text-align:left;
      padding: 8px 10px;
      border-bottom: 1px solid #e6e6e6;
    }

    .tabela-efetivo tbody td{
      padding: 8px 10px;
      border-bottom: 1px solid #efefef;
      vertical-align: top;
    }

    .tabela-efetivo tbody tr:last-child td{ border-bottom:none; }

    .tabela-efetivo th:last-child,
    .tabela-efetivo td:last-child{
      width: 130px;
      min-width: 130px;
    }

    .tabela-efetivo input[type="text"]{
      width: 100%;
      height: 34px;
      border: 1px solid #d9d9d9;
      border-radius: 8px;
      padding: 6px 8px;
      background:#fff;
      font-size: 12px;
      line-height: 1.2;
    }

    .tabela-efetivo input[type="number"]{
      width: 80px;
      min-width: 80px;
      max-width: 100%;
      height: 34px;
      border: 1px solid #d9d9d9;
      border-radius: 8px;
      padding: 6px 8px;
      background:#fff;
      font-size: 12px;
      text-align: center;
    }

    .btn-remover-linha{
      height: 29px;
      min-width: 96px;
      width: 100%;
      padding: 0 8px;
      border-radius: 8px;
      border: 1px solid var(--cor-principal);
      background: var(--cor-principal);
      color: #fff;
      font-weight: 900;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      box-sizing: border-box;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn-remover-linha:hover{
      background: var(--cor-principal-escura);
      border-color: var(--cor-principal-escura);
    }

    .btn-adicionar-mais{
      display:inline-flex;
      align-items:center;
      gap:10px;
      margin-top: 10px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(196,0,0,.22);
      background: rgba(196,0,0,.08);
      color: var(--cor-principal);
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
    }
    .btn-adicionar-mais:hover{ background: rgba(196,0,0,.12); }

    /* IMAGENS */
    .grid-imagens{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .dropbox{
      width: 100%;
      height: 120px;
      border: 2px dashed #ccc;
      border-radius: 6px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      color: #777;
      background:#f9f9f9;
      position: relative;
      overflow:hidden;
      cursor:pointer;
    }

    .dropbox img{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .dropbox input[type="file"] { display:none; }

    .remove-btn{
      position: absolute;
      top: 2px;
      right: 4px;
      width: auto;
      height: auto;
      background: none;
      border: none;
      color: #fff;
      font-size: 10px;
      font-weight: 600;
      line-height: 1;
      padding: 5px;
      margin: 0;
      cursor: pointer;
      z-index: 2;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .dropbox:hover .remove-btn{
      opacity: 1;
      pointer-events: auto;
    }
    .dropbox.show-remove .remove-btn{
      opacity: 1;
      pointer-events: auto;
    }

    /* BOT√ïES / RODAP√â */
    .button-container,
    .botoes{
      text-align:center;
      margin-top: 16px;
    }

    button{
      padding: 10px 20px;
      background: var(--cor-principal);
      border:none;
      border-radius: 6px;
      color:#fff;
      font-size: 14px;
      font-weight: 900;
      cursor:pointer;
    }
    button:hover{ background: var(--cor-principal-escura); }

    input:focus, textarea:focus, select:focus, button:focus{
      outline:none;
      box-shadow:none;
    }

    .rodape-versao{
      margin-top: 10px;
      text-align:center;
      font-size: 12px;
      color:#777;
    }

    /* REVIS√ÉO / PDF ‚Äî mantendo MESMO visual do formul√°rio */
    .container-revisao {
      max-width: 920px;
      margin: 0 auto;
      padding: 18px;
      background: #ffffff;
    }

    /* inputs/checkboxes na revis√£o n√£o edit√°veis, mas com o mesmo visual */
    .rev-only input,
    .rev-only textarea{
      pointer-events: none;
      user-select: none;
    }
    .rev-only input[type="checkbox"]{
      pointer-events: none;
    }

    /* ocultar bot√µes ‚ÄúRemover‚Äù e ‚ÄúAdicionar mais‚Äù na revis√£o */
    .rev-only .btn-remover-linha,
    .rev-only .btn-adicionar-mais{
      display:none !important;
    }

    /* tornar dropbox da revis√£o n√£o clic√°vel */
    .rev-only .dropbox{
      cursor: default;
      border-style: solid;
      border-color: #e3e3e3;
      background:#fff;
    }
    .rev-only .dropbox .remove-btn{ display:none !important; }

    /* RESPONSIVO */
    @media (max-width: 768px){
      .container{ padding: 12px; }
      .container-revisao{ padding: 12px; }

      .header-container{ gap: 24px; }
      .header-container img{ height: 38px; }

      .grid-imagens{ grid-template-columns: repeat(2, 1fr); }
      .dropbox{ height: 110px; }

      .linha-dupla-checks{ grid-template-columns: 1fr; }
      .topo-campos-grid{ grid-template-columns: 1fr; }

      #grupoClima, #rev_grupoClima{ grid-template-columns: 1fr 1fr; }

      .tabela-efetivo thead{ display:none; }
      .tabela-efetivo, .tabela-efetivo tbody, .tabela-efetivo tr, .tabela-efetivo td{
        display:block;
        width:100%;
      }
      .tabela-efetivo tbody tr{
        border-bottom: 1px solid #eee;
        padding: 10px 10px;
      }
      .tabela-efetivo tbody td{
        border:none;
        padding: 6px 0;
      }
      .tabela-efetivo td[data-label]::before{
        content: attr(data-label);
        display:block;
        font-size: 11px;
        font-weight: 900;
        color:#666;
        margin-bottom: 4px;
        text-transform: uppercase;
      }

      .tabela-efetivo input[type="number"]{ width: 100%; min-width: 0; }
    }

    @media (max-width: 420px){
      #grupoClima, #rev_grupoClima{ grid-template-columns: 1fr; }
    }

    /* IMPRESS√ÉO / PDF (A4) */
    @media print{
      body{
        margin:0 !important;
        padding:0 !important;
        background:#fff;
      }

      /* imprime s√≥ a revis√£o */
      #containerFormulario{ display:none !important; }
      #containerRevisao{ display:block !important; }

      .container-revisao{
        max-width: none;
        padding: 0 !important;
      }

      /* A4 com margens ‚Äúprofissionais‚Äù */
      .print-area{
        width: 210mm;
        min-height: 297mm;
        padding: 10mm;
        box-sizing: border-box;
      }

      .botoes{ display:none !important; }
      .rodape-versao{ display:none !important; }
    }

    /* ====== AUDIO UI ====== */
    .audio-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn-secundario{
      padding:10px 14px;
      font-size:13px;
      background:#666;
      border-radius:6px;
      color:#fff;
      border:none;
      font-weight:900;
      cursor:pointer;
    }
    .btn-acao{
      padding:10px 14px;
      font-size:13px;
      border-radius:6px;
      border:none;
      font-weight:900;
      cursor:pointer;
      background: var(--cor-principal);
      color:#fff;
    }
    .btn-acao:disabled,
    .btn-secundario:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .tag-aux{
      display:block;
      margin-top:8px;
      color:#666;
      font-size:12px;
    }
    .warn{
      margin-top:8px;
      color:#a10000;
      font-size:12px;
      font-weight:700;
      display:none;
    }
  </style>

  <script>
    const VERSAO_ROBO = 'MM Dantas ¬∑ Di√°rio de Obra ¬∑ v1.0.6';

    function atualizarContador(textarea) {
      const contador = document.getElementById('contador_' + textarea.id);
      if (contador) contador.textContent = textarea.value.length + " / " + textarea.maxLength;
    }

    document.addEventListener('DOMContentLoaded', function () {
      const dataRegistroInput = document.getElementById('dataRegistro');
      if (dataRegistroInput) {
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const dia = String(hoje.getDate()).padStart(2, '0');
        const hojeStr = `${ano}-${mes}-${dia}`;

        dataRegistroInput.min = hojeStr;
        if (!dataRegistroInput.value) dataRegistroInput.value = hojeStr;
      }

      document.querySelectorAll('.versaoRoboTexto').forEach(el => {
        el.textContent = VERSAO_ROBO;
      });

      const respInput = document.getElementById('responsavel');
      if (respInput) {
        const params = new URLSearchParams(window.location.search);
        const respUrl = params.get('responsavel');

        if (respUrl) {
          const nomeDecodificado = decodeURIComponent(respUrl.replace(/\+/g, ' '));
          respInput.value = nomeDecodificado;
        } else {
          const salvo = localStorage.getItem('responsavel_diario');
          if (salvo) respInput.value = salvo;
        }
      }
    });

    /* =========================
       ADD/REMOVE
       ========================= */
    function removerLinha(btn){
      const tr = btn.closest('tr');
      const tbody = tr.parentElement;

      if (tbody.querySelectorAll('tr').length <= 1) {
        tr.querySelectorAll('input').forEach(i => i.value = '');
        return;
      }
      tr.remove();
    }

    function addLinhaPresentes(){
      const tbody = document.querySelector('#tablePresentes tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Fun√ß√£o">
          <input type="text" class="pres-funcao">
        </td>
        <td data-label="Quantidade">
          <input type="number" min="0" max="999" class="pres-qtde">
        </td>
        <td data-label="Remover">
          <button type="button" class="btn-remover-linha" onclick="removerLinha(this)">Remover</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    function addLinhaTerceiros(){
      const tbody = document.querySelector('#tableTerceiros tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Servi√ßo/Empresa">
          <input type="text" class="terc-servico" placeholder="Digite algo (Ex.: El√©trica)">
        </td>
        <td data-label="Quantidade">
          <input type="number" min="0" max="999" class="terc-qtde">
        </td>
        <td data-label="Remover">
          <button type="button" class="btn-remover-linha" onclick="removerLinha(this)">Remover</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    function addLinhaAusentes(){
      const tbody = document.querySelector('#tableAusentes tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Nome">
          <input type="text" class="aus-nome" placeholder="Digite algo (Ex.: Jo√£o Silva)">
        </td>
        <td data-label="Fun√ß√£o">
          <input type="text" class="aus-funcao" placeholder="Digite algo (Ex.: Servente)">
        </td>
        <td data-label="Motivo">
          <input type="text" class="aus-motivo" placeholder="Digite algo (Ex.: Atestado)">
        </td>
        <td data-label="Remover">
          <button type="button" class="btn-remover-linha" onclick="removerLinha(this)">Remover</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    function lerPresentesTabela(){
      const linhas = [];
      document.querySelectorAll('#tablePresentes tbody tr').forEach(tr => {
        const funcao = (tr.querySelector('.pres-funcao')?.value || '').trim();
        const qtde = (tr.querySelector('.pres-qtde')?.value || '').trim();
        if (funcao && qtde) linhas.push({ funcao, qtde });
      });
      return linhas;
    }

    function lerTerceirosTabela(){
      const linhas = [];
      document.querySelectorAll('#tableTerceiros tbody tr').forEach(tr => {
        const serv = (tr.querySelector('.terc-servico')?.value || '').trim();
        const qtde = (tr.querySelector('.terc-qtde')?.value || '').trim();
        if (serv && qtde) linhas.push({ serv, qtde });
      });
      return linhas;
    }

    function lerAusentesTabela(){
      const linhas = [];
      document.querySelectorAll('#tableAusentes tbody tr').forEach(tr => {
        const nome = (tr.querySelector('.aus-nome')?.value || '').trim();
        const func = (tr.querySelector('.aus-funcao')?.value || '').trim();
        const mot  = (tr.querySelector('.aus-motivo')?.value || '').trim();

        if (nome || func || mot) {
          if (!nome || !func || !mot) throw new Error('AUSENTE_INCOMPLETO');
          linhas.push({ nome, func, mot });
        }
      });
      return linhas;
    }
  </script>
</head>

<body>

<!-- ========== TELA DE REVIS√ÉO (MESMO LAYOUT DO FORMUL√ÅRIO) ========== -->
<div id="containerRevisao" class="container-revisao rev-only" style="display: none;">
  <div id="printArea" class="print-area">
    <div class="header-container">
      <img src=" " alt="MM DANTAS">
      <img src=" " alt="Green Village">
    </div>

    <div class="topo-bloco">
      <div class="topo-titulo-box">
        <p class="titulo-principal">DI√ÅRIO DE OBRA</p>
        <div class="titulo-sub">MM DANTAS - OBRA: <span class="destaque" id="rev_obraTitulo">GREEN VILLAGE</span></div>
      </div>

      <div class="topo-campos-grid">
        <div class="campo-topo">
          <label>IN√çCIO DA OBRA</label>
          <input type="text" id="rev_inicio" readonly>
        </div>

        <div class="campo-topo">
          <label>PREVIS√ÉO DE T√âRMINO</label>
          <input type="text" id="rev_termino" readonly>
        </div>

        <div class="campo-topo">
          <label class="required">DATA DE REGISTRO</label>
          <input type="text" id="rev_dataRegistro" readonly>
        </div>

        <div class="campo-topo">
          <label class="required">RESPONS√ÅVEL</label>
          <input type="text" id="rev_responsavel" readonly>
        </div>
      </div>

      <input type="hidden" id="rev_obra" value="Green Village" />
    </div>

    <div class="separador"></div>

    <!-- CONDI√á√ïES (MESMO) -->
    <div class="quadrado-blocos">
      <div class="linha-dupla-checks">
        <div class="bloco-checks">
          <label class="required titulo-bloco">Condi√ß√µes Meteorol√≥gicas:</label>
          <div id="rev_grupoClima">
            <label><input type="checkbox" value="Ensolarado"><img src="https://img.icons8.com/emoji/48/000000/sun-emoji.png" alt="Sol">Ensolarado</label>
            <label><input type="checkbox" value="Nublado"><img src="https://img.icons8.com/emoji/48/000000/cloud-emoji.png" alt="Nuvem">Nublado</label>
            <label><input type="checkbox" value="Chuva"><img src="https://img.icons8.com/emoji/48/000000/cloud-with-rain-emoji.png" alt="Chuva">Chuva</label>
            <label><input type="checkbox" value="Vento"><img src="https://img.icons8.com/ios-filled/50/000000/wind.png" alt="Vento">Vento</label>
          </div>
        </div>

        <div class="bloco-checks">
          <label class="required titulo-bloco">Condi√ß√µes da Obra:</label>
          <div id="rev_grupoObra">
            <label><input type="checkbox" value="Pratic√°vel">Pratic√°vel</label>
            <label><input type="checkbox" value="Impratic√°vel">Impratic√°vel</label>
            <label><input type="checkbox" value="Pratic√°vel com interfer√™ncia">Pratic√°vel com interfer√™ncia</label>
          </div>
        </div>
      </div>
    </div>

    <div class="separador"></div>

    <!-- PRESENTES + TERCEIRIZADOS (MESMO) -->
    <div class="quadrado-blocos">
      <div class="linha-dupla-checks">

        <div class="bloco-efetivo-card" id="rev_cardPresentes">
          <div class="bloco-efetivo-titulo">
            <span class="emoji">üë∑</span>
            <span>COLABORADORES PRESENTES</span>
          </div>

          <table class="tabela-efetivo" id="rev_tablePresentes">
            <thead>
              <tr>
                <th style="width:66%;">Fun√ß√£o</th>
                <th style="width:12%;">Quantidade</th>
                <th style="width:22%;"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <button type="button" class="btn-adicionar-mais">‚ûï Adicionar mais</button>
        </div>

        <div class="bloco-efetivo-card" id="rev_cardTerceiros">
          <div class="bloco-efetivo-titulo">
            <span class="emoji">üèóÔ∏è</span>
            <span>TERCEIRIZADOS</span>
          </div>

          <table class="tabela-efetivo" id="rev_tableTerceiros">
            <thead>
              <tr>
                <th style="width:66%;">Servi√ßo/Empresa</th>
                <th style="width:12%;">Quantidade</th>
                <th style="width:22%;"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <button type="button" class="btn-adicionar-mais">‚ûï Adicionar mais</button>
        </div>

      </div>
    </div>

    <div class="separador"></div>

    <!-- AUSENTES (MESMO) -->
    <div class="bloco-efetivo-card" id="rev_cardAusentes">
      <div class="bloco-efetivo-titulo">
        <span class="emoji">üö´</span>
        <span>COLABORADORES AUSENTES</span>
      </div>

      <table class="tabela-efetivo" id="rev_tableAusentes">
        <thead>
          <tr>
            <th style="width:30%;">Nome</th>
            <th style="width:25%;">Fun√ß√£o</th>
            <th style="width:25%;">Motivo</th>
            <th style="width:20%;"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button type="button" class="btn-adicionar-mais">‚ûï Adicionar mais</button>
    </div>

    <div class="separador"></div>

    <label class="required" style="margin-top:0;">Descri√ß√£o dos Trabalhos em Andamento:</label>
    <textarea id="rev_descricao" readonly></textarea>

    <div class="separador"></div>

    <label style="margin-top:0;">Coment√°rios Gerais:</label>
    <textarea id="rev_comentarios" readonly></textarea>

    <div class="separador"></div>

    <label class="required" style="margin-top:0;">Imagem:</label>
    <div class="grid-imagens" id="rev_gridImagens"></div>

    <div class="separador"></div>

    <label style="margin-top:0;">Anexar V√≠deo (opcional):</label>
    <input type="text" id="rev_videoNome" readonly style="width:100%; padding:8px; margin-top:4px; font-size:12px;">

    <div class="separador"></div>

    <label style="margin-top:0;">√Åudio (opcional):</label>
    <input type="text" id="rev_audioNome" readonly style="width:100%; padding:8px; margin-top:4px; font-size:12px;">

    <div class="rodape-versao">
      <span class="versaoRoboTexto"></span>
    </div>
  </div>

  <div class="botoes">
    <button onclick="voltarFormulario()">Editar</button>
    <button onclick="downloadTudoSemZip()">DOWNLOAD (PDF + ARQUIVOS)</button>
  </div>
</div>

<script>
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  function baixarBlobComoArquivo(blobOrFile, filename){
    const url = URL.createObjectURL(blobOrFile);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 2000);
  }

  async function gerarPDFBlob() {
    const area = document.getElementById('printArea');

    const dataEl = document.getElementById('rev_dataRegistro');
    if (!area || !dataEl || (dataEl.value || '').trim() === '') {
      alert('Antes de gerar o PDF, clique em "Enviar Registro" para preencher a revis√£o.');
      return null;
    }

    const botoes = document.querySelector('#containerRevisao .botoes');
    const botoesDisplayOld = botoes ? botoes.style.display : null;
    if (botoes) botoes.style.display = 'none';

    const opcoes = {
      margin: [0, 0, 0, 0],
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, allowTaint: true, logging: false, scrollY: 0 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak: { mode: ['css', 'legacy'] }
    };

    const restaurar = () => {
      if (botoes) botoes.style.display = botoesDisplayOld;
    };

    try{
      const worker = html2pdf().set(opcoes).from(area).toPdf();
      const pdf = await worker.get('pdf');

      const total = pdf.internal.getNumberOfPages();
      if (total > 1) {
        const ultima = pdf.internal.pages[total];
        if (!ultima || ultima.length <= 2) pdf.deletePage(total);
      }

      const blob = pdf.output('blob');
      restaurar();
      return blob;
    } catch (e){
      console.error(e);
      restaurar();
      alert('Falha ao gerar PDF.');
      return null;
    }
  }

  // ======= SALVAR EM PASTA (SEM ZIP) ‚Äî Chrome/Edge =======
  // (Obs: o navegador N√ÉO permite salvar ‚Äúautomaticamente‚Äù na mesma pasta do HTML sem voc√™ escolher uma pasta.
  // Aqui, voc√™ escolhe UMA pasta-base e o sistema cria a pasta do registro sozinho.)
  async function salvarEmPastaSemZip(pdfBlob, baseName){
    if (!window.showDirectoryPicker) return false;

    try{
      const dir = await window.showDirectoryPicker({ mode: 'readwrite' });

      // cria subpasta do registro automaticamente
      const folderName = `Diario_de_Obra_${baseName}`;
      const subdir = await dir.getDirectoryHandle(folderName, { create: true });

      // PDF (na MESMA pasta do registro)
      {
        const fh = await subdir.getFileHandle(`Diario_de_Obra_${baseName}.pdf`, { create: true });
        const w = await fh.createWritable();
        await w.write(pdfBlob);
        await w.close();
      }

      // Imagens (na MESMA pasta do registro ‚Äî SEM subpasta)
      for (let i=0; i<imagens.length; i++){
        const file = imagens[i];
        if (!file) continue;
        const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
        const fname = `imagem_${String(i+1).padStart(2,'0')}.${ext}`;
        const fh = await subdir.getFileHandle(fname, { create: true });
        const w = await fh.createWritable();
        await w.write(file);
        await w.close();
      }

      // V√≠deo (na MESMA pasta do registro ‚Äî SEM subpasta)
      if (videoAnexado){
        const ext = (videoAnexado.name.split('.').pop() || 'mp4').toLowerCase();
        const safe = `video_${baseName}.${ext}`;
        const fh = await subdir.getFileHandle(safe, { create: true });
        const w = await fh.createWritable();
        await w.write(videoAnexado);
        await w.close();
      }

      // √Åudio (na MESMA pasta do registro ‚Äî SEM subpasta)
      if (audioAnexado){
        const ext = (audioAnexado.name.split('.').pop() || 'mp3').toLowerCase();
        const safe = `audio_${baseName}.${ext}`;
        const fh = await subdir.getFileHandle(safe, { create: true });
        const w = await fh.createWritable();
        await w.write(audioAnexado);
        await w.close();
      }

      alert(`‚úÖ Pasta criada automaticamente e arquivos salvos: ${folderName}`);
      return true;
    } catch (e){
      console.warn('Usu√°rio cancelou ou sem permiss√£o:', e);
      return false;
    }
  }

  // ======= DOWNLOAD SEM ZIP (universal = v√°rios arquivos) =======
  async function downloadTudoSemZip(){
    const pdfBlob = await gerarPDFBlob();
    if (!pdfBlob) return;

    const dataRegistro = (document.getElementById('rev_dataRegistro')?.value || 'registro').trim();
    const baseName = dataRegistro.replaceAll('-', '_').replaceAll('/', '_');

    // 1) tenta salvar em pasta (Chrome/Edge) ‚Äî SEM ZIP
    const salvouEmPasta = await salvarEmPastaSemZip(pdfBlob, baseName);
    if (salvouEmPasta) return;

    // 2) fallback universal: v√°rios downloads
    alert('Seu navegador n√£o permite salvar em uma pasta diretamente. Vou baixar os arquivos separados (PDF + m√≠dias).');

    baixarBlobComoArquivo(pdfBlob, `Diario_de_Obra_${baseName}.pdf`);
    await sleep(350);

    // imagens
    for (let i=0; i<imagens.length; i++){
      const file = imagens[i];
      if (!file) continue;
      const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
      baixarBlobComoArquivo(file, `imagem_${String(i+1).padStart(2,'0')}.${ext}`);
      await sleep(350);
    }

    // video (padronizado)
    if (videoAnexado){
      const ext = (videoAnexado.name.split('.').pop() || 'mp4').toLowerCase();
      baixarBlobComoArquivo(videoAnexado, `video_${baseName}.${ext}`);
      await sleep(350);
    }

    // audio (padronizado)
    if (audioAnexado){
      const ext = (audioAnexado.name.split('.').pop() || 'mp3').toLowerCase();
      baixarBlobComoArquivo(audioAnexado, `audio_${baseName}.${ext}`);
      await sleep(350);
    }
  }

  function voltarFormulario() {
    document.getElementById('containerRevisao').style.display = 'none';
    document.getElementById('containerFormulario').style.display = 'block';
  }

  // util: limpa e preenche tabela da revis√£o
  function preencherTabelaRev(tbodySelector, rowsHtml){
    const tbody = document.querySelector(tbodySelector);
    if (!tbody) return;
    tbody.innerHTML = rowsHtml || '';
  }

  function marcarChecksRevisao(containerId, valores){
    const cont = document.getElementById(containerId);
    if (!cont) return;
    cont.querySelectorAll('input[type="checkbox"]').forEach(ch => {
      ch.checked = valores.includes(ch.value);
    });
  }

  function preencherImagensRevisao(){
    const gridRev = document.getElementById('rev_gridImagens');
    if (!gridRev) return;
    gridRev.innerHTML = '';

    // cria 6 boxes (mesmo layout)
    for (let i=0; i<imagens.length; i++){
      const box = document.createElement('div');
      box.className = 'dropbox';

      const file = imagens[i];
      if (file){
        const img = document.createElement('img');
        const reader = new FileReader();
        reader.onload = () => { img.src = reader.result; };
        reader.readAsDataURL(file);
        box.appendChild(img);
      } else {
        const sp = document.createElement('span');
        sp.innerText = 'Sem imagem';
        box.appendChild(sp);
      }

      gridRev.appendChild(box);
    }
  }
</script>

<!-- ========== FORMUL√ÅRIO PRINCIPAL ========== -->
<div class="container" id="containerFormulario">
  <div class="header-container">
    <img src=" " alt="MM Dantas">
    <img src="" alt="Green Village">
  </div>

  <div class="topo-bloco">
    <div class="topo-titulo-box">
      <p class="titulo-principal">DI√ÅRIO DE OBRA</p>
      <div class="titulo-sub">MM DANTAS - OBRA: <span class="destaque">GREEN VILLAGE</span></div>
    </div>

    <div class="topo-campos-grid">
      <div class="campo-topo">
        <label for="inicio">IN√çCIO DA OBRA</label>
        <input type="text" id="inicio" name="inicio" value="24/02/2025" readonly>
      </div>

      <div class="campo-topo">
        <label for="termino">PREVIS√ÉO DE T√âRMINO</label>
        <input type="text" id="termino" name="termino" value="02/2026" readonly>
      </div>

      <div class="campo-topo">
        <label for="dataRegistro" class="required">DATA DE REGISTRO</label>
        <input type="date" id="dataRegistro" name="dataRegistro" required>
      </div>

      <div class="campo-topo">
        <label for="responsavel" class="required">RESPONS√ÅVEL</label>
        <input type="text" id="responsavel" name="responsavel" placeholder="Nome completo">
      </div>
    </div>

    <input type="hidden" id="obra" value="Green Village" />
  </div>

  <div class="separador"></div>

  <!-- CONDI√á√ïES -->
  <div class="quadrado-blocos">
    <div class="linha-dupla-checks">
      <div class="bloco-checks">
        <label class="required titulo-bloco">Condi√ß√µes Meteorol√≥gicas:</label>
        <div id="grupoClima">
          <label><input type="checkbox" name="condicoesMeteorologicas" value="Ensolarado"><img src="https://img.icons8.com/emoji/48/000000/sun-emoji.png" alt="Sol">Ensolarado</label>
          <label><input type="checkbox" name="condicoesMeteorologicas" value="Nublado"><img src="https://img.icons8.com/emoji/48/000000/cloud-emoji.png" alt="Nuvem">Nublado</label>
          <label><input type="checkbox" name="condicoesMeteorologicas" value="Chuva"><img src="https://img.icons8.com/emoji/48/000000/cloud-with-rain-emoji.png" alt="Chuva">Chuva</label>
          <label><input type="checkbox" name="condicoesMeteorologicas" value="Vento"><img src="https://img.icons8.com/ios-filled/50/000000/wind.png" alt="Vento">Vento</label>
        </div>
      </div>

      <div class="bloco-checks">
        <label class="required titulo-bloco">Condi√ß√µes da Obra:</label>
        <div id="grupoObra">
          <label><input type="checkbox" name="condicoesObra" value="Pratic√°vel">Pratic√°vel</label>
          <label><input type="checkbox" name="condicoesObra" value="Impratic√°vel">Impratic√°vel</label>
          <label><input type="checkbox" name="condicoesObra" value="Pratic√°vel com interfer√™ncia">Pratic√°vel com interfer√™ncia</label>
        </div>
      </div>
    </div>
  </div>

  <div class="separador"></div>

  <!-- ====== PRESENTES + TERCEIRIZADOS ====== -->
  <div class="quadrado-blocos">
    <div class="linha-dupla-checks">

      <!-- COLABORADORES PRESENTES -->
      <div class="bloco-efetivo-card" id="cardPresentes">
        <div class="bloco-efetivo-titulo">
          <span class="emoji">üë∑</span>
          <span>COLABORADORES PRESENTES</span>
        </div>

        <table class="tabela-efetivo" id="tablePresentes">
          <thead>
            <tr>
              <th style="width:66%;">Fun√ß√£o</th>
              <th style="width:12%;">Quantidade</th>
              <th style="width:22%;"></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td data-label="Fun√ß√£o">
                <input type="text" value="Pedreiro" class="pres-funcao" readonly>
              </td>
              <td data-label="Quantidade">
                <input type="number" min="0" max="15" placeholder="" class="pres-qtde">
              </td>
              <td data-label="Remover">
                <button type="button" class="btn-remover-linha" onclick="removerLinha(this)">Remover</button>
              </td>
            </tr>
          </tbody>
        </table>

        <button type="button" class="btn-adicionar-mais" onclick="addLinhaPresentes()">
          ‚ûï Adicionar mais
        </button>
      </div>

      <!-- TERCEIRIZADOS -->
      <div class="bloco-efetivo-card" id="cardTerceiros">
        <div class="bloco-efetivo-titulo">
          <span class="emoji">üèóÔ∏è</span>
          <span>TERCEIRIZADOS</span>
        </div>

        <table class="tabela-efetivo" id="tableTerceiros">
          <thead>
            <tr>
              <th style="width:66%;">Servi√ßo/Empresa</th>
              <th style="width:12%;">Quantidade</th>
              <th style="width:22%;"></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td data-label="Servi√ßo/Empresa">
                <input type="text" class="terc-servico" placeholder="Ex.: El√©trica">
              </td>
              <td data-label="Quantidade">
                <input type="number" min="0" max="15" placeholder="" class="terc-qtde">
              </td>
              <td data-label="Remover">
                <button type="button" class="btn-remover-linha" onclick="removerLinha(this)">Remover</button>
              </td>
            </tr>
          </tbody>
        </table>

        <button type="button" class="btn-adicionar-mais" onclick="addLinhaTerceiros()">
          ‚ûï Adicionar mais
        </button>
      </div>

    </div>
  </div>

  <div class="separador"></div>

  <!-- AUSENTES -->
  <div class="bloco-efetivo-card" id="cardAusentes">
    <div class="bloco-efetivo-titulo">
      <span class="emoji">üö´</span>
      <span>COLABORADORES AUSENTES</span>
    </div>

    <table class="tabela-efetivo" id="tableAusentes">
      <thead>
        <tr>
          <th style="width:30%;">Nome</th>
          <th style="width:25%;">Fun√ß√£o</th>
          <th style="width:25%;">Motivo</th>
          <th style="width:20%;"></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td data-label="Nome">
            <input type="text" class="aus-nome" placeholder="Ex.: Jo√£o Silva">
          </td>
          <td data-label="Fun√ß√£o">
            <input type="text" class="aus-funcao" placeholder="Ex.: Servente">
          </td>
          <td data-label="Motivo">
            <input type="text" class="aus-motivo" placeholder="Ex.: Atestado">
          </td>
          <td data-label="Remover">
            <button type="button" class="btn-remover-linha" onclick="removerLinha(this)">Remover</button>
          </td>
        </tr>
      </tbody>
    </table>

    <button type="button" class="btn-adicionar-mais" onclick="addLinhaAusentes()">
      ‚ûï Adicionar mais
    </button>
  </div>

  <div class="separador"></div>

  <label for="descricao" class="required" style="margin-top:0;">Descri√ß√£o dos Trabalhos em Andamento:</label>
  <textarea id="descricao" maxlength="1000" oninput="atualizarContador(this)"></textarea>
  <div class="char-count" id="contador_descricao">0 / 1000</div>

  <div class="separador"></div>

  <label for="comentarios" style="margin-top:0;">Coment√°rios Gerais:</label>
  <textarea id="comentarios" maxlength="1000" oninput="atualizarContador(this)"></textarea>
  <div class="char-count" id="contador_comentarios">0 / 1000</div>

  <div class="separador"></div>

  <label class="required" style="margin-top:0;">Imagem:</label>
  <div class="grid-imagens" id="gridImagens"></div>

  <div class="separador"></div>

  <!-- ‚úÖ V√çDEO (ANEXAR) -->
  <label style="margin-top:0;">Anexar V√≠deo (opcional):</label>
  <input type="file" id="videoFile" accept="video/*"
         style="width: 100%; padding: 8px; margin-top: 4px; font-size:12px;">
  <small id="videoNome" class="tag-aux"></small>

  <div class="separador"></div>

  <!-- ‚úÖ √ÅUDIO (GRAVAR OU ANEXAR) -->
  <label style="margin-top:0;">√Åudio (opcional):</label>

  <div class="audio-actions">
    <button type="button" id="btnGravarAudio" class="btn-acao">üéôÔ∏è Gravar √°udio</button>
    <button type="button" id="btnPararAudio" class="btn-secundario" style="display:none;">‚èπÔ∏è Parar</button>

    <label for="audioFile" style="margin:0;">
      <span style="display:inline-block;padding:10px 14px;border-radius:6px;background:#f3f3f3;border:1px solid #ddd;cursor:pointer;font-weight:900;">
        üìé Anexar arquivo
      </span>
    </label>

    <input type="file" id="audioFile" accept="audio/*" capture="microphone" style="display:none;">
  </div>

  <div id="audioWarn" class="warn">
    ‚ö†Ô∏è O navegador bloqueou o microfone. Abra este formul√°rio por <b>HTTPS</b> (GitHub Pages) ou <b>localhost</b> e permita o microfone no cadeado üîí.
  </div>

  <small id="audioNome" class="tag-aux"></small>
  <audio id="audioPreview" controls style="width:100%;margin-top:10px;display:none;"></audio>

  <div class="button-container">
    <button type="button" onclick="validarFormulario()">Enviar Registro</button>
  </div>

  <div class="rodape-versao">
    <span class="versaoRoboTexto"></span>
  </div>
</div>

<script>
  /* =========================
     IMAGENS
     ========================= */
  const maxBoxes = 6;
  const grid = document.getElementById("gridImagens");
  const imagens = new Array(maxBoxes).fill(null);

  // Arquivos anexados/gravados
  let videoAnexado = null;
  let audioAnexado = null;

  // =========================
  // GRAVA√á√ÉO DE √ÅUDIO (MediaRecorder)
  // =========================
  let mediaRecorderAudio = null;
  let audioChunks = [];
  let audioMime = 'audio/webm';

  function mostrarAvisoAudio(b){
    const warn = document.getElementById('audioWarn');
    if (!warn) return;
    warn.style.display = b ? 'block' : 'none';
  }

  function setAudioSelecionado(fileOrBlob, nomeArquivo){
    if (fileOrBlob instanceof File) {
      audioAnexado = fileOrBlob;
    } else {
      const ext = (audioMime.includes('ogg') ? 'ogg' : audioMime.includes('mp4') ? 'm4a' : 'webm');
      const fileName = nomeArquivo || `audio_gravado.${ext}`;
      audioAnexado = new File([fileOrBlob], fileName, { type: audioMime });
    }

    const aNome = document.getElementById("audioNome");
    const preview = document.getElementById("audioPreview");

    if (aNome) aNome.textContent = audioAnexado ? `Selecionado: ${audioAnexado.name}` : '';
    if (preview) {
      if (audioAnexado) {
        preview.src = URL.createObjectURL(audioAnexado);
        preview.style.display = 'block';
      } else {
        preview.removeAttribute('src');
        preview.style.display = 'none';
      }
    }
  }

  async function iniciarGravacaoAudio(){
    const btnGravar = document.getElementById('btnGravarAudio');
    const btnParar  = document.getElementById('btnPararAudio');

    mostrarAvisoAudio(false);

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('Seu navegador n√£o suporta grava√ß√£o de √°udio. Use "Anexar arquivo".');
      return;
    }

    const isSecure = window.isSecureContext || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if (!isSecure) {
      mostrarAvisoAudio(true);
      alert('Para gravar √°udio, abra este formul√°rio em HTTPS (GitHub Pages) ou em localhost. No arquivo local (file://) o navegador bloqueia.');
      return;
    }

    try{
      if (navigator.permissions && navigator.permissions.query) {
        try {
          const p = await navigator.permissions.query({ name: 'microphone' });
          if (p && p.state === 'denied') {
            mostrarAvisoAudio(true);
            alert('O microfone est√° BLOQUEADO no navegador. Clique no cadeado üîí do site e permita o microfone, depois recarregue.');
            return;
          }
        } catch (_) {}
      }

      const possiveis = [
        'audio/webm;codecs=opus',
        'audio/webm',
        'audio/ogg;codecs=opus',
        'audio/ogg',
        'audio/mp4'
      ];
      audioMime = possiveis.find(t => window.MediaRecorder && MediaRecorder.isTypeSupported(t)) || 'audio/webm';

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioChunks = [];

      mediaRecorderAudio = new MediaRecorder(stream, { mimeType: audioMime });
      mediaRecorderAudio.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorderAudio.onstop = () => {
        stream.getTracks().forEach(t => t.stop());
        const blob = new Blob(audioChunks, { type: audioMime });
        setAudioSelecionado(blob, null);

        if (btnGravar) btnGravar.style.display = 'inline-block';
        if (btnParar)  btnParar.style.display  = 'none';
      };

      mediaRecorderAudio.start();

      if (btnGravar) btnGravar.style.display = 'none';
      if (btnParar)  btnParar.style.display  = 'inline-block';

    } catch (e){
      console.error(e);

      if (e && (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError')) {
        mostrarAvisoAudio(true);
        alert('Permiss√£o do microfone negada. Clique no cadeado üîí do site e permita o microfone, depois recarregue.');
        return;
      }

      if (e && e.name === 'NotFoundError') {
        alert('Nenhum microfone foi encontrado no dispositivo.');
        return;
      }

      if (e && (e.name === 'SecurityError' || e.name === 'NotSupportedError')) {
        mostrarAvisoAudio(true);
        alert('O navegador bloqueou o microfone. Use HTTPS (GitHub Pages) ou localhost.');
        return;
      }

      alert('N√£o foi poss√≠vel acessar o microfone. Verifique as permiss√µes do navegador.');
    }
  }

  function pararGravacaoAudio(){
    if (mediaRecorderAudio && mediaRecorderAudio.state !== 'inactive') {
      mediaRecorderAudio.stop();
    }
  }

  function habilitarXPorToque(box){
    box.addEventListener('touchstart', () => {
      box.classList.add('show-remove');
      clearTimeout(box._timer);
      box._timer = setTimeout(() => {
        box.classList.remove('show-remove');
      }, 1500);
    }, { passive: true });
  }

  function criarBoxes() {
    for (let i = 0; i < maxBoxes; i++) {
      const box = document.createElement("div");
      box.className = "dropbox";
      box.dataset.index = i;

      const texto = document.createElement("span");
      texto.innerText = "Adicionar imagem";

      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.addEventListener("change", (e) => carregarImagem(i, e.target.files[0]));

      const btnRemover = document.createElement("button");
      btnRemover.innerText = "‚úï";
      btnRemover.className = "remove-btn";
      btnRemover.onclick = (e) => {
        e.stopPropagation();
        removerImagem(i);
      };

      box.appendChild(texto);
      box.appendChild(input);
      box.appendChild(btnRemover);

      box.addEventListener("click", () => input.click());

      box.addEventListener("dragover", (e) => {
        e.preventDefault();
        box.style.borderColor = "#666";
      });

      box.addEventListener("dragleave", () => {
        box.style.borderColor = "#ccc";
      });

      box.addEventListener("drop", (e) => {
        e.preventDefault();
        box.style.borderColor = "#ccc";
        const file = e.dataTransfer.files[0];
        if (file) carregarImagem(i, file);
      });

      box.addEventListener("paste", (e) => {
        const items = e.clipboardData.items;
        for (const item of items) {
          if (item.type.indexOf("image") !== -1) {
            const file = item.getAsFile();
            if (file) carregarImagem(i, file);
          }
        }
      });

      grid.appendChild(box);
      habilitarXPorToque(box);
    }
  }

  function carregarImagem(index, file) {
    if (!file || !file.type.startsWith("image/")) {
      alert("Por favor, envie apenas imagens.");
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      imagens[index] = file;
      const box = grid.children[index];
      box.innerHTML = "";

      const img = document.createElement("img");
      img.src = reader.result;

      const btnRemover = document.createElement("button");
      btnRemover.innerText = "‚úï";
      btnRemover.className = "remove-btn";
      btnRemover.onclick = (e) => {
        e.stopPropagation();
        removerImagem(index);
      };

      box.appendChild(img);
      box.appendChild(btnRemover);
      habilitarXPorToque(box);
    };
    reader.readAsDataURL(file);
  }

  function removerImagem(index) {
    imagens[index] = null;
    const box = grid.children[index];
    box.innerHTML = "";

    const texto = document.createElement("span");
    texto.innerText = "Adicionar imagem";

    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.addEventListener("change", (e) => carregarImagem(index, e.target.files[0]));

    const btnRemover = document.createElement("button");
    btnRemover.innerText = "‚úï";
    btnRemover.className = "remove-btn";
    btnRemover.onclick = (e) => {
      e.stopPropagation();
      removerImagem(index);
    };

    box.appendChild(texto);
    box.appendChild(input);
    box.appendChild(btnRemover);
    habilitarXPorToque(box);
  }

  criarBoxes();

  // listeners v√≠deo/√°udio + bot√µes gravar/parar
  document.addEventListener("DOMContentLoaded", () => {
    const v = document.getElementById("videoFile");
    const a = document.getElementById("audioFile");

    const vNome = document.getElementById("videoNome");

    const btnGravar = document.getElementById("btnGravarAudio");
    const btnParar  = document.getElementById("btnPararAudio");

    if (v) v.addEventListener("change", (e) => {
      videoAnexado = e.target.files[0] || null;
      if (vNome) vNome.textContent = videoAnexado ? `Selecionado: ${videoAnexado.name}` : "";
    });

    // se anexar √°udio, substitui o gravado
    if (a) a.addEventListener("change", (e) => {
      const f = e.target.files[0] || null;
      if (!f) return;
      setAudioSelecionado(f, f.name);
    });

    if (btnGravar) btnGravar.addEventListener('click', iniciarGravacaoAudio);
    if (btnParar)  btnParar.addEventListener('click', pararGravacaoAudio);
  });

  /* =========================
     ENVIO / REVIS√ÉO
     ========================= */
  function validarFormulario() {
    const data = document.getElementById('dataRegistro');
    const descricao = document.getElementById('descricao');
    const clima = document.querySelectorAll('input[name="condicoesMeteorologicas"]:checked');
    const obraCond = document.querySelectorAll('input[name="condicoesObra"]:checked');
    const responsavel = document.getElementById('responsavel');

    const temImagem = imagens.some(f => f !== null);

    if (!responsavel.value.trim()) {
      alert('Informe o respons√°vel pelo registro.');
      responsavel.focus();
      return;
    }

    if (!data.value || !descricao.value.trim() || clima.length === 0 || obraCond.length === 0 || !temImagem) {
      alert('Preencha todos os campos obrigat√≥rios (incluindo pelo menos uma imagem).');
      return;
    }

    let ausentes = [];
    try {
      ausentes = lerAusentesTabela();
    } catch (e) {
      if (e.message === 'AUSENTE_INCOMPLETO') {
        alert('Em "Colaboradores Ausentes", se preencher uma linha, complete Nome, Fun√ß√£o e Motivo.');
        return;
      }
    }

    // ======= Preenche REVIS√ÉO (mesmo layout) =======
    const obra = document.getElementById('obra').value;

    document.getElementById('rev_obra').value = obra;
    document.getElementById('rev_obraTitulo').textContent = obra;

    document.getElementById('rev_inicio').value = document.getElementById('inicio').value;
    document.getElementById('rev_termino').value = document.getElementById('termino').value;
    document.getElementById('rev_dataRegistro').value = data.value;
    document.getElementById('rev_responsavel').value = responsavel.value.trim();

    // checks clima/obra
    const climaVals = Array.from(clima).map(c => c.value);
    const obraVals  = Array.from(obraCond).map(c => c.value);
    marcarChecksRevisao('rev_grupoClima', climaVals);
    marcarChecksRevisao('rev_grupoObra', obraVals);

    // tabelas
    const presentes = lerPresentesTabela();
    const terceiros = lerTerceirosTabela();

    const presHtml = (presentes.length ? presentes : [{funcao:'-', qtde:''}]).map(p => `
      <tr>
        <td data-label="Fun√ß√£o"><input type="text" value="${(p.funcao||'')}" readonly></td>
        <td data-label="Quantidade"><input type="number" value="${(p.qtde||'')}" readonly></td>
        <td data-label=""><button type="button" class="btn-remover-linha">Remover</button></td>
      </tr>
    `).join('');
    preencherTabelaRev('#rev_tablePresentes tbody', presHtml);

    const tercHtml = (terceiros.length ? terceiros : [{serv:'-', qtde:''}]).map(t => `
      <tr>
        <td data-label="Servi√ßo/Empresa"><input type="text" value="${(t.serv||'')}" readonly></td>
        <td data-label="Quantidade"><input type="number" value="${(t.qtde||'')}" readonly></td>
        <td data-label=""><button type="button" class="btn-remover-linha">Remover</button></td>
      </tr>
    `).join('');
    preencherTabelaRev('#rev_tableTerceiros tbody', tercHtml);

    const ausHtml = (ausentes.length ? ausentes : [{nome:'-', func:'', mot:''}]).map(a => `
      <tr>
        <td data-label="Nome"><input type="text" value="${(a.nome||'')}" readonly></td>
        <td data-label="Fun√ß√£o"><input type="text" value="${(a.func||'')}" readonly></td>
        <td data-label="Motivo"><input type="text" value="${(a.mot||'')}" readonly></td>
        <td data-label=""><button type="button" class="btn-remover-linha">Remover</button></td>
      </tr>
    `).join('');
    preencherTabelaRev('#rev_tableAusentes tbody', ausHtml);

    // textos
    document.getElementById('rev_descricao').value = descricao.value;
    document.getElementById('rev_comentarios').value = document.getElementById('comentarios').value;

    // imagens
    preencherImagensRevisao();

    // v√≠deo/√°udio: nome na revis√£o
    document.getElementById('rev_videoNome').value = videoAnexado ? `üé• ${videoAnexado.name}` : '-';
    document.getElementById('rev_audioNome').value = audioAnexado ? `üéß ${audioAnexado.name}` : '-';

    try { localStorage.setItem('responsavel_diario', responsavel.value.trim()); } catch (e) {}

    // troca telas
    document.getElementById('containerFormulario').style.display = 'none';
    document.getElementById('containerRevisao').style.display = 'block';
  }
</script>

</body>
</html>
